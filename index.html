<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Weather App</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <div class="header">
    <h1>Weather Dashboard</h1>

  </div>
  <div class="container-fluid">
    <div class="row">

      <!-- Sidebar -->
      <nav class="col-md-3 d-none d-md-block bg-light sidebar">
        <div class="sidebar-sticky">

          <!-- City Search  -->
          <h5>Search for a City:</h5>
          <form class="form-inline form-sm active-pink my-2">
            <input class="form-control form-control-sm w-70 mr-1" id="citySearch" type="text" placeholder="Search"
              aria-label="Search">
            <button type="submit" class="btn-sm btn-primary search">
              <i class="fas fa-search-location"></i>
            </button>
          </form>

          <!-- Sidebar Search History -->
          <ul class="nav flex-column">
            <!--  li for navigating to main -->
            <li class="nav-item assisstive">
              <a class="nav-link active" href="#main">
                <!-- TODO fix this for screenreaders -->
                <span class="sr-only">(current)</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main -->
      <main role="main" class="col-md-9 ml-sm-auto px-4" id="main">
        <div class="current-weather">
          <h4 class="location-name" id="location-name"></h4>
          <p class="loc location-temp">Search for a US city to see the current weather</p>
          <p class="loc location-humidity"></p>
          <p class="loc location-wind"></p>
          <p class="loc location-uv"></p>
        </div>
        <div class="w-100"></div>
        <div class="mt-16 forecast-weather">
          <h5>5-Day Forecast</h5>
          <div class="card-deck">
            <div class="card text-white bg-primary mb-3" data-day="1" style="max-width: 10rem;">
              <div class="card-header"></div>
              <div class="card-body">
                <p class="card-text card-icon"></p>
                <p class="card-text card-temp"></p>
                <p class="card-text card-humidity"></p>
              </div>
            </div>
            <div class="card text-white bg-primary mb-3" data-day="2" style="max-width: 10rem;">
              <div class="card-header">Header</div>
              <div class="card-body">
                <p class="card-text card-icon">Icon </p>
                <p class="card-text card-temp">Temp: </p>
                <p class="card-text card-humidity">Humidity: </p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

  </div>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script src="https://kit.fontawesome.com/dcec7c4e9b.js" crossorigin="anonymous"></script>
  <script src="config.js"></script>
  <script>
    var units = 'imperial';
    var deg = 'F';
    const input = $('#citySearch');

    let searchedCities = localStorage.getItem('searchHistory') ?
        JSON.parse(localStorage.getItem('searchHistory')) : [];
    
    // From https://gist.github.com/johnsmith17th/5424570 
    function toCamelCase(str) {
      return str.toLowerCase().replace(/(?:(^.)|(\s+.))/g, function(match) {
        return match.charAt(match.length-1).toUpperCase();
      });
    }
    // #### Functions
    // Search for a city
    $(".search").on("click", function(e) {
      e.preventDefault();
      e.stopPropagation();
      citySearch = input.val().trim().toLowerCase();

      getWeather(citySearch);
      // #### Create search history
      searchedCities.push(toCamelCase(citySearch));
      // Put cityName value in local storage
      let searchHistory = localStorage.setItem('searchHistory', JSON.stringify(searchedCities) );
      
      // const searchSet = [... new Set(searchedCities.map( item => item.toLowerCase()))];
      const searchSet = [... new Set(searchedCities)].map( search =>
        `<li class="nav-item search_history" date-city=${search}>
          <a class="nav-link" href='#' onclick='getWeather("${search}")'>
            <span class="searched_city">${search}</span>
          </a>
        </li>`);

        $('.nav').empty().append(searchSet);
        input.get(0).value = '';
    });
    
    // Create search history 

    // API call functions
    function getWeather(cityName) {

      const dayQueryURL = `http://api.openweathermap.org/data/2.5/weather?q=${cityName}&units=${units}&APPID=${apiKey}`;
      // Openweather Weather API call
      $.ajax({
        url: dayQueryURL,
        method: "GET"
      }).then(getWeatherByCity);

      // Openweather Forecast API call
      const forecastQueryURL =
        `http://api.openweathermap.org/data/2.5/forecast?q=${cityName}&units=${units}&APPID=${apiKey}`;
      $.ajax({
        url: forecastQueryURL,
        method: "GET"
      }).then(getForecastByCity)
    }

    function getWeatherByCity(response) {
      let iconCode = response.weather[0].icon;
      const iconURL = `http://openweathermap.org/img/wn/${iconCode}@2x.png`;
      const today = moment().format("L");

      // City Name, Date, and Weather Icon
      $("#location-name").empty().append(`${response.name} (${today}) <img src="${iconURL}">`);

      // Temperature, Humidity, Wind Speed
      $(".location-temp").empty().append(`Temperature: ${response.main.temp.toFixed(1)} Â°${deg}`);
      $(".location-humidity").empty().append(`Humidity: ${response.main.humidity}%`);
      $(".location-wind").empty().append(`Wind Speed: ${response.wind.speed.toFixed()} MPH`);
    }

    function getForecastByCity(response) {

      // Filter the response to an array of responses for each day
      const eachDayResponse =[];

      const filteredResponse = (response, range) => {
       return response.list.filter( list => list.dt>= range[0] && list.dt<=range[1]);
      };
      
      for (let i=0; i<5; i++) {
        let startDay = moment().add((i+1), 'days').startOf('day').format('X');
        let endDay = moment().add((i+1), 'days').endOf('day').format('X');
        let dayRange = [startDay, endDay];
        eachDayResponse.push(filteredResponse(response, dayRange));
      }

      $(".card").each(function() {
        let d = this.dataset.day;
        let cardIconCode = eachDayResponse[d-1][3].weather[0].icon;

        const average = ;

        let temp = eachDayResponse[d-1].map( t => t.main.temp)
          .reduce( (total, each) => total + each, 0) / eachDayResponse[d-1].length;
        console.log(temp);
        let humidity = eachDayResponse[d-1].map( h => h.main.humidity)
        .reduce( (total, each) => total + each, 0) / eachDayResponse[d-1].length;

        const cardIconURL = `http://openweathermap.org/img/wn/${cardIconCode}@2x.png`;
        const date = moment().add(`${this.dataset.day}`, 'days').format('L');

        $(this).children('.card-header').empty().append(`${date}`);
        $(this).find('.card-icon').empty().append(`<img src="${cardIconURL}">`);
        $(this).find('.card-temp').empty().append(`${temp.toFixed(1)}`);
        $(this).find('.card-humidity').empty().append(`${humidity}`);

      });
    }
  </script>
</body>

</html>